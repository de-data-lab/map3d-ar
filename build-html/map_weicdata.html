<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Map of Resources Available to Wilmington Children & Families</title>
        <meta name="description" content="You are here, in a 3D map of data from the UD Biden School & Wilmington Educational Improvement Commission (WEIC)">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta http-equiv="cache-control" content="no-cache">
        <meta http-equiv="expires" content="0">
        <meta http-equiv="pragma" content="no-cache">
        
        <!-- Mapbox GL JS -->
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
        <!--
            Mapbox Directions
        -->
        <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
        <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
        
        <!-- Turf.js -->
        <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
        <!-- Polyline -->
        <script src=https://cdnjs.cloudflare.com/ajax/libs/mapbox-polyline/1.1.1/polyline.js></script>

        <!-- Three.js -->
        <script src="https://unpkg.com/three@0.126.0/build/three.min.js"></script>
        <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>

        <!-- Parser.js -->
        <script src="./js/parser.js"></script>

        <!-- D3.js  -->
        <script src="https://d3js.org/d3.v3.min.js"></script>
        <script src="https://d3js.org/d3-collection.v1.min.js"></script>
        <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
        <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
        <script src="https://d3js.org/d3-request.v1.min.js"></script>

        <style type="text/css">
            @font-face {
                font-family: 'Roboto Mono';
                src: local('Roboto Mono'), local('RobotoMono-Regular'), url('../assets/RobotoMono-Regular.woff2') format('woff2');
                font-style: normal;
                font-weight: 400;
            }
            @font-face {
                font-family: 'Roboto Mono';
                src: local('Roboto Mono Medium'), local('RobotoMono-Medium'), url('../assets/RobotoMono-Medium.woff2') format('woff2');
                font-style: normal;
                font-weight: 500;
            }
            @font-face {
                font-family: 'Greycliff';
                src: local('Greycliff'), local('GreycliffCF-DemiBold'), url('../assets/GreycliffCF-DemiBold.woff2') format('woff2');
                font-style: normal;
                font-weight: 200;
            }
            * {
                margin: 0;
                padding: 0;
                font-family: 'Roboto Mono';
            }
            html, body, section {
                height: 100%;
                font-family: sans-serif;
            }
            body {
                background-color: #100826;
                font-size: 0.85rem;
                line-height: 150%;
                text-align: left;
            }
            img {
                width: 9rem;
                padding-left: 60px;
                padding-right: 60px;
                padding-bottom: 0px;
                padding-top: 30px;
                color: #49dbce;
            }
            img:hover {
                color: #ef2d5e;
            }
            a img {
                padding-left: 0px;
                padding-right: 0px;
                padding-bottom: 0px;
                padding-top: 30px;
            }
            a img:hover {
                color: #ef2d5e;
            }
            h1 {
                font-size: 2.5rem;
                line-height: 150%;
                margin: 0 0 0rem 0;
                color: #49dbce;
                opacity: 1.0;
                padding-left: 20px;
                padding-right: 20px;
                padding-top: 80px;
                padding-bottom: 60px;
                font-family: 'Greycliff';
            }
            h3 {
                font-family: 'Greycliff';
                font-size: 2rem;
                line-height: 150%;
                margin: 0 0 0rem 0;
                color: #4600ff;
                padding-left: 20px;
                padding-top: 30px;
                padding-bottom: 10px;
                padding-right: 20px;
            }
            p {
                color: #fff;
                opacity: 1.0;
                padding-left: 20px;
                padding-right: 20px;
                padding-bottom: 30px;
                line-height: 2rem;
            }
            /*
            a {
                color: #49dbce;
                padding-left: 60px;
                padding-right: 60px;
                padding-top: 0px;
                padding-bottom: 30px;
                line-height: 2rem;
                text-decoration: none;
            }
            */
            a:hover {
                color: #ef2d5e;
                transition: ease-in 150ms;
            }
            a {
                color: #49dbce;
                opacity: 1.0;
                padding-left: 60px;
                padding-right: 60px;
                padding-top: 10px;
                padding-bottom: 0px;
                line-height: 0.5rem;
                text-decoration: none;
                transition: ease-out 500ms;
            }
            .mapboxgl-popup-content {
                font-family: 'Roboto Mono';
                padding: 5%;
                width: 300px;
            }
            .mapboxgl-popup-content-wrapper {
                padding: 2%;
            }
            .wrapper {
                display: flex;
            }
            #map {
                height: 100vh;
                width: 100%;
            }
            #collapse_button {
                transform: rotate(45deg);
                padding: 0 0rem;     
                margin: 1 2rem;
                width: 30px;
                height: 30px;
                transition: 500ms ease;
            }
            .controlpanel {
                background-color: #100826;
                border-radius: 0rem;
                border: none;
                flex-basis: 0;
                transition: 500ms ease;
                padding-left: 0px;
                padding-right: 0px;
                width: 0;
                height: 100vh;
                opacity: 0.0;
                overflow-y: scroll;
                overflow-x: hidden;
            }
            .open {
                flex-basis: 30%;
                border: solid 0.2rem #49dbce;
                border-radius: 0rem;
                transition: 500ms ease;
                opacity: 1.0;
            }
            .controlpanel-toggle {
                background-color: #100826;
                color: #fff;
                border: solid 0.2rem #49dbce;
                border-radius: 0rem;
                padding: 0.5rem;
                height: 100vh;
                top: 1rem;
                left: 1rem;
                width: 60px;
                position: inherit;
                z-index: 1000;
                transition: 500ms ease;
            }
            .toggleopen {
                border: solid 0.2rem #062a3e;
                width: 40px;
            }
            .faded {
                opacity: 0.0;
                transition: 170ms ease;
            }
            .visible {
                opacity: 1.0;
                transition: 1000ms ease;
            }
            .listbar {
                background: none;
                color: #fff;
                position: relative;
                left: 0rem;
                bottom: 1.8rem;
                margin: 20px 20px 20px 20px;
                padding: 1rem;
                width: max-content;
                margin: none;
                border: none;
                border-radius: 0.5rem;
                font-family: 'Roboto Mono', sans-serif;
            }
            .cattable {
                border-spacing: 0.5rem;
                padding-bottom: 0;
            }
            .cattable td {
                 border-spacing: 0.5rem;
            }
            .cattable .checkboxlabel {
                width: fit-content;
            }
            .cattable .colorswatch {
                width: 1.5rem;
                border-radius: 0.2rem;
            }
            #satellite {
                background-color: #00b0e1;
            }
            #extruded-buildings, #resources, #youarehere {
                background-color: #4600ff;
            }
            #satellite, #extruded-buildings, #resources, #youarehere {
                color: #fff;
                margin: 10px 10px 10px 10px;
                border-radius: 0.5em;
                cursor: pointer;
                position: relative;
                text-align: center;
                justify-self: center;
                font-family: 'Roboto Mono', sans-serif;
            }
            #reports {
                color: #fff;
            }
            .sidebar {
                position: relative;
                margin: 0px 10px 0px 20px;
                padding: 20px;
                border: none;
                border-radius: 0.5rem;
                background: none;
                overflow-y: scroll;
            }
            .card {
                font-size: small;
                border-bottom: solid #d3d3d3 2px;
                margin-bottom: 6px;
            }
            .card-header {
                font-weight: bold;
                padding: 6px;
            }
            .no-route {
                background-color: #d3d3d3;
                color: #000;
            }
            .resource-found {
                background-color: #33a532;
                color: #fff;
            }
            .route-found {
                background-color: #f00; /*#33a532;*/
                color: #fff;
            }
            .card-details {
                padding: 3px 6px;
            }
            .tilogo {
                background-image: url('../assets/techimpact_mainlogo_clear_space.svg');
                background-size: cover;
                width: 50px;
                height: 50px;
                cursor: pointer;
            }
            /* arrow common style */
            .arrow {
                display: inline-block;
                width: 30px;
                height: 30px;
                border-top: 5px solid #49dbce;
                border-right: 5px solid #49dbce;
                border-radius: 0.5rem;
                transition: 500ms ease;
            }
            .arrow:hover {
                border-top: 4px solid #ef2d5e;
                border-right: 4px solid #ef2d5e;
            }
            .arrow-rotate-left {
                transform: rotate(-180deg);
                transition: 500ms ease;
                padding: 0 0rem;     
                margin: 1 2rem;
            }
        </style>
    </head>
    <body>
        <!-- HTML -->
        
        <!-- Flexbox -->
        <div class="wrapper">
            <div id="map"></div>
            <div class="controlpanel">
                <h1 class="faded">Resources for Wilmington Children & Families</h1>
                <p class="faded">A 3D map of data from the Wilmington Educational Improvement Commission (WEIC), assessing resources available to families and children in Wilmington, in the fields of Education, Nutrition, Healthcare, Transportation, and so many more.</p>
                <p class="faded">Witness the accessibility and distribution of resources in the state of Delaware, in immersive, engaging 3D!</p>

                <!-- Fly to you-are-here location -->
                <h3 class="faded">You Are Here</h3>
                <div id="youarehere" class="faded">Fly To Your Location</div>

                <!-- Turn on/off layers -->
                <h3 class="faded">On/Off</h3>
                <div id="resources" class="on faded">Hide Resources</div>
                <div id="extruded-buildings" class="on faded">Hide 3D Buildings</div>
                <div id="satellite" class="faded">Add satellite</div>

                <!-- Categories list -->
                <h3 class="faded">Filters</h3>
                <div id="catlist" class="listbar faded">
                    <!--
                    <label class="switch" id="selectionslider">
                        <input name="selectionmethodslider" type="checkbox" value="HardSelect" checked="checked">
                        <span class="slider round"></span>
                    </label>
                    <label class="switchlabel">Hard Select</label>
                    -->
                    <table class="cattable">
                        <tr>
                            <td class="checkboxlabel">
                                <input class="filter_All" id="AllCategories" value="AllCategories" type="checkbox"
                                    onclick="
                                        for (var i = 0; i < filtercatsboxes.length; i++){
                                            filtercatsboxes[i].checked = this.checked;
                                        }
                                    "
                                    onchange="selectAllCatsUpdate.call(this, event)"
                                    checked="checked">ALL</input>
                            </td>
                        </tr>
                        <tr>
                            <td class="checkboxlabel">
                                <input class="filter_AcademicEducational" id="AcademicEducational" name="filters" value="AcademicEducational" type="checkbox"
                                    onchange="filterCatsUpdate.call(this, event)"
                                    checked="checked">Academic & Educational</input>
                            </td>
                            <td class="colorswatch" style="background-color: #01DEE6;"></td>
                        </tr>
                        <tr>
                            <td class="checkboxlabel">
                                <input class="filter_EarlyChildhood" id="EarlyChildhood" name="filters" value="EarlyChildhood" type="checkbox"
                                    onchange="filterCatsUpdate.call(this, event)"
                                    checked="checked">Early Childhood</input>
                            </td>
                            <td class="colorswatch" style="background-color: #FFDB15;"></td>
                        </tr>
                        <tr>
                            <td class="checkboxlabel">
                                <input class="filter_FoodNutrition" id="FoodNutrition" name="filters" value="FoodNutrition" type="checkbox"
                                    onchange="filterCatsUpdate.call(this, event)"
                                    checked="checked">Food & Nutrition</input>
                            </td>
                            <td class="colorswatch" style="background-color: #A8E10C;"></td>
                        </tr>
                        <tr>
                            <td class="checkboxlabel">
                                <input class="filter_HealthHealthcare" id="HealthHealthcare" name="filters" value="HealthHealthcare" type="checkbox"
                                    onchange="filterCatsUpdate.call(this, event)"
                                    checked="checked">Health & Healthcare</input>
                            </td>
                            <td class="colorswatch" style="background-color: #FF5765;"></td>
                        </tr>
                        <tr>
                            <td class="checkboxlabel">
                                <input class="filter_Housing" id="Housing" name="filters" value="Housing" type="checkbox"
                                    onchange="filterCatsUpdate.call(this, event)"
                                    checked="checked">Housing</input>
                            </td>
                            <td class="colorswatch" style="background-color: #952B60;"></td>
                        </tr>
                        <tr>
                            <td class="checkboxlabel">
                                <input class="filter_MentalHealth" id="MentalHealth" name="filters" value="MentalHealth" type="checkbox"
                                    onchange="filterCatsUpdate.call(this, event)"
                                    checked="checked">Mental Health</input>
                            </td>
                            <td class="colorswatch" style="background-color: #4B0082;"></td>
                        </tr>
                        <tr>
                            <td class="checkboxlabel">
                                <input class="filter_Recreational" id="Recreational" name="filters" value="Recreational" type="checkbox"
                                    onchange="filterCatsUpdate.call(this, event)"
                                    checked="checked">Recreational</input>
                            </td>
                            <td class="colorswatch" style="background-color: #FF66E9"></td>
                        </tr>
                        <tr>
                            <td class="checkboxlabel">
                                <input class="filter_Transportation" id="Transportation" name="filters" value="Transportation" type="checkbox"
                                    onchange="filterCatsUpdate.call(this, event)"
                                    checked="checked">Transportation</input>
                            </td>
                            <td class="colorswatch" style="background-color: #3D91E0;"></td>
                        </tr>
                        <tr>
                            <td class="checkboxlabel">
                                <input class="filter_Other" id="Other" name="filters" value="Other" type="checkbox"
                                    onchange="filterCatsUpdate.call(this, event)"
                                    checked="checked">Other</input>
                            </td>
                            <td class="colorswatch" style="background-color: #FDA649;"></td>
                        </tr>
                    </table>
                </div>

                <!-- Reports from Mapbox Directions (Routes) -->
                <h3 class="faded">Reports</h3>
                <div class="sidebar faded">
                    <div id="reports"></div>
                </div>
            </div>
            <button class="controlpanel-toggle"
                onclick="
                    console.log(`Opening side panel ...`);
                    //
                    var controlpanel = document.querySelector('.controlpanel');
                    controlpanel.classList.toggle('open');
                    controlpanel.querySelectorAll('.faded').forEach(e => e.classList.toggle('visible'));
                    const directionMultiplier = controlpanel.classList.contains('open') ? 1 : -1; 
                    map.panBy([100*directionMultiplier, 0], { 
                        duration: 500,
                        easing: (t) => t<.5 ? 2*t*t : -1+(4-2*t)*t 
                    });
                    this.classList.toggle('toggleopen');
                    this.querySelector('span').classList.toggle('arrow-rotate-left');
                    //
                    console.log(`Opened side panel!`);
                ">
                <div id="collapse_button">
                    <span class="arrow"></span>
                </div>
            </button>
        </div>

        <!-- JavaScript -->
        <script>
            const THREE = window.THREE;

            console.log(
                Parser.evaluate('6 * x', { x: 7 })
            );

            const params = {
                accessToken: 'pk.eyJ1IjoibGlsbXJob3VzZSIsImEiOiJja3d1cm5nOHQxdDlrMnZueWY4dzlrbHY2In0.g14m2o2rHvNYYdDSsjwmqQ',
                styles: {
                    warmfuzzy: 'mapbox://styles/lilmrhouse/clckubrie00dw14qtav0gsq4u',
                    purplelight: 'mapbox://styles/lilmrhouse/clcqnng2b000915sfqmiihlkj',
                    purpledark: 'mapbox://styles/lilmrhouse/clcb57hs900ek14oxroe22xub'
                },
                center: [
                    -75.551,
                    39.738
                ],
                projections: {
                    mercator: 'mercator',
                    globe: 'globe'
                },
                hash: false,
                pitch: 60,
                zoom: 16.09,
                minZoom: 0,
                maxZoom: 50,
                scrollZoom: true
            };
            var Categories = {
                AcademicEducational: [],
                EarlyChildhood: [], 
                FoodNutrition: [], 
                HealthHealthcare: [], 
                Housing: [],
                MentalHealth: [],
                Recreational: [],  
                Transportation: [], 
                Other: []
            };
            var CategoryColors = {
                FoodNutrition: "#A8E10C",       //A8E10C - Kelly Green
                HealthHealthcare: "#FF5765",    //FF5765 - Coral
                AcademicEducational: "#01DEE6", //01DEE6 - Teal
                EarlyChildhood: "#FFDB15",      //FFDB15 - Yellow
                Recreational: "#FF66E9",        //FF66E9 - Hot Pink
                Housing: "#952B60",             //952B60 - Dark Pink
                MentalHealth: "#4B0082",        //8A6FDF - Violet
                Transportation: "#3D91E0",      //3D91E0 - Deep Blue 
                Other: "#FDA649"                //FDA649 - Beige Orange
            };

            const catlist = document.getElementById('catlist');
            const filtercatsboxes = document.getElementsByName('filters');
            const youarehereSwitch = document.getElementById('youarehere');
            const satelliteSwitch = document.getElementById('satellite');
            const buildingsSwitch = document.getElementById('extruded-buildings');
            const resourcesSwitch = document.getElementById('resources');

            const TechImpactLocations = {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [-75.75751,39.66319]
                            },
                        properties: {
                            title: 'Tech Impact ~ FinTech Building',
                            description: 'Newark, DE'
                        }
                    },
                    {
                        type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [-75.55143,39.73657]
                            },
                        properties: {
                            title: 'Tech Impact ~ CSC Station',
                            description: 'Wilmington, DE'
                        }
                    }
                ]
            };
            const TopologyLocations = {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [0, 0]
                            },
                        properties: {
                            title: 'Atlantic',
                            description: 'Near Africa'
                        }
                    },
                    {
                        type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [39.73657, -75.55143]
                            },
                        properties: {
                            title: 'Antarctic',
                            description: 'In Antarctica'
                        }
                    }
                ]
            };
            var dotsdata = {};
            var mygeo = [0,0];

            // Add user location
            const options = {
                enableHighAccuracy: true,
                timeout: 9000,
                maximumAge: 0
            };
            function success(pos) {
                const crd = pos.coords;
                //
                console.log('Your current position is:');
                console.log(`Latitude : ${crd.latitude}`);
                console.log(`Longitude: ${crd.longitude}`);
                console.log(`More or less ${crd.accuracy} meters.`);
                //
                mygeo = [crd.longitude,crd.latitude];
                console.log(mygeo);
                //
                var mygeodata = {
                    type: 'FeatureCollection',
                    features: [
                        {
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'Point',
                                coordinates: mygeo
                            }
                        }
                    ]
                };
                map.getSource('mygeodata').setData(mygeodata);
                /*
                map.flyTo({
                    center: mygeo,
                    essential: true
                }); */
            }
            function error(err) {
                console.warn(`ERROR(${err.code}): ${err.message}`);
            }
            function setMyGeolocation() {
                if ("geolocation" in navigator) { 
                    console.log("Geolocation in navigator");
                    navigator.geolocation.getCurrentPosition(success, error, options);
                } else { console.log("Geolocation not available!"); }
            }


            // Add UI functionality onclick
            youarehereSwitch.onclick = () => {
                map.flyTo({
                    center: mygeo,
                    essential: true // this animation is considered essential with respect to prefers-reduced-motion
                });
            };
            resourcesSwitch.onclick = () => {
                if (resourcesSwitch.classList.contains("on")) {
                    map.setLayoutProperty('weic-features', 'visibility', 'none');
                    map.setLayoutProperty('heat-glow-base', 'visibility', 'none');
                    map.setLayoutProperty('heat-glow-mid', 'visibility', 'none');
                    resourcesSwitch.classList.toggle('on');
                    resourcesSwitch.style.backgroundColor = "#00b0e1";
                    resourcesSwitch.style.transition = "all 300ms ease-in";
                    resourcesSwitch.innerHTML = "Show Resources"
                }
                else {
                    map.setLayoutProperty('weic-features', 'visibility', 'visible');
                    map.setLayoutProperty('heat-glow-base', 'visibility', 'visible');
                    map.setLayoutProperty('heat-glow-mid', 'visibility', 'visible');
                    resourcesSwitch.classList.toggle('on');
                    resourcesSwitch.style.backgroundColor = "#4600ff";
                    resourcesSwitch.style.transition = "all 300ms ease-out";
                    resourcesSwitch.innerHTML = "Hide Resources";
                }
            }
            buildingsSwitch.onclick = () => {
                if (buildingsSwitch.classList.contains("on")) {
                    map.setLayoutProperty('extruded-buildings', 'visibility', 'none');
                    buildingsSwitch.classList.toggle('on');
                    buildingsSwitch.style.backgroundColor = "#00b0e1";
                    buildingsSwitch.style.transition = "all 300ms ease-in";
                    buildingsSwitch.innerHTML = "Show 3D Buildings"
                }
                else {
                    map.setLayoutProperty('extruded-buildings', 'visibility', 'visible');
                    buildingsSwitch.classList.toggle('on');
                    buildingsSwitch.style.backgroundColor = "#4600ff";
                    buildingsSwitch.style.transition = "all 300ms ease-out";
                    buildingsSwitch.innerHTML = "Hide 3D Buildings";
                }
            }
            satelliteSwitch.onclick = () => {
                if (satelliteSwitch.classList.contains("on")) {
                    map.setLayoutProperty('satellite', 'visibility', 'none');
                    satelliteSwitch.classList.toggle('on');
                    satelliteSwitch.style.backgroundColor = "#00b0e1";
                    satelliteSwitch.style.transition = "all 300ms ease-in";
                    satelliteSwitch.innerHTML = "Show satellite";
                }
                else {
                    map.setLayoutProperty('satellite', 'visibility', 'visible');
                    satelliteSwitch.classList.toggle('on');
                    satelliteSwitch.style.backgroundColor = "#4600ff";
                    satelliteSwitch.style.transition = "all 300ms ease-out";
                    satelliteSwitch.innerHTML = "Hide satellite";
                }
            }

            
            // Add the map
            mapboxgl.accessToken = params.accessToken;
            const map = new mapboxgl.Map({
                container: 'map',
                style: params.styles.purplelight,
                projection: params.projections.globe,
                center: params.center,
                hash: params.hash,
                pitch: params.pitch,
                zoom: params.zoom,
                minZoom: params.minZoom,
                maxZoom: params.maxZoom,
                scrollZoom: params.scrollZoom,
                attributionControl: {
                    position: 'bottom-left'
                }
            });

            // Add navigation (zoom and rotation) controls
            map.addControl(new mapboxgl.NavigationControl(), 'top-left');

            // Add the routes UI
            const directions = new MapboxDirections({
                accessToken: mapboxgl.accessToken,
                unit: 'metric',
                profile: 'mapbox/driving',
                alternatives: true,
                geometries: 'geojson',
                controls: { instructions: true },
                flyTo: false,
                bbox: [params.center[0]-2, params.center[1]-2, params.center[0]+2, params.center[1]+2], // Boundary for Berkeley
                proximity: {
                    longitude: params.center[0],
                    latitude: params.center[1]
                }
            });
            map.addControl(directions, 'top-right');

            // Add TechImpact locations to the map
            for (const tifeature of TechImpactLocations.features) {
                console.log(tifeature.geometry);
                console.log(tifeature.geometry.coordinates);
                //
                const el = document.createElement('div');
                el.className = 'tilogo';
                new mapboxgl.Marker(el).setLngLat(tifeature.geometry.coordinates).addTo(map);
            }

            // Add map content
            map.on('load', () => {
                //Images
                map.loadImage(
                    'https://docs.mapbox.com/mapbox-gl-js/assets/cat.png',
                    (error, image) => {
                        if (error) throw error;
                        map.addImage('cat', image);
                    });

                //Sources
                //Sources for routes
                map.addSource('theRoute', {
                    type: 'geojson',
                    data: {
                        type: 'Feature'
                    }
                });
                map.addSource('theBox', {
                    type: 'geojson',
                    data: {
                        type: 'Feature'
                    }
                });

                // Source for you-are-here point
                map.addSource('mygeodata', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            {
                                type: 'Feature',
                                properties: {},
                                geometry: {
                                    type: 'Point',
                                    coordinates: mygeo
                                }
                            }
                        ]
                    }
                });

                //Source for params.center point
                map.addSource('parametricCenter', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            {
                                type: 'Feature',
                                properties: {},
                                geometry: {
                                    type: 'Point',
                                    coordinates: params.center
                                }
                            }
                        ]
                    }
                });

                //Sources for data-driven content
                map.addSource('building', {
                    type: 'vector',
                    url: 'mapbox://mapbox.mapbox-streets-v8'
                });
                map.addSource('census-tract-shapefile', {
                    type: 'vector',
                    url: 'mapbox://lilmrhouse.d98p8764'
                });
                map.addSource('census-block-shapefile', {
                    type: 'vector',
                    url: 'mapbox://lilmrhouse.dmq52p9v'
                });
                map.addSource('dots', {
                    type: 'vector',
                    url: 'mapbox://lilmrhouse.3atow0lv'
                });
                

                //Layers
                //Layers for routes
                map.addLayer({
                    id: 'theRoute',
                    type: 'line',
                    source: 'theRoute',
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#cccccc',
                        'line-opacity': 0.5,
                        'line-width': 13,
                        'line-blur': 0.5
                    }
                });
                map.addLayer({
                    id: 'theBox',
                    type: 'fill',
                    source: 'theBox',
                    layout: {},
                    paint: {
                        'fill-color': '#FFC300',
                        'fill-opacity': 0.5,
                        'fill-outline-color': '#FFC300'
                    }
                });

                //Layer for parametric center
                map.addLayer({
                    id: 'paramscenterpoint',
                    type: 'circle',
                    source: 'parametricCenter',
                    layout: {},
                    paint: {
                        'circle-opacity': 0,    //set this >0, <1 to see the point
                        'circle-color': 'white',
                        'circle-radius': 120
                    }
                });

                //Layer for you-are-here point
                map.addLayer({
                    id: 'mygeopoint',
                    type: 'symbol',
                    source: 'mygeodata',
                    layout: {
                        'icon-image': 'cat',
                        'icon-size': 0.2,
                        'text-field': 'You are here'
                    },
                    paint: {
                        'text-color': 'yellow',
                        'text-translate': [0, 45]
                    }
                });

                //Layers
                map.addLayer({
                    'id': 'satellite',
                    'source': {
                        'type': 'raster',
                        'url': 'mapbox://mapbox.satellite',
                        'tileSize': 256
                    },
                    'type': 'raster',
                    'layout': {
                        'visibility': 'none'
                    }
                });
                map.addLayer({
                    'id': 'census-tract-fills',
                    'type': 'fill',
                    'source': 'census-tract-shapefile',
                    'source-layer': 'tl_rd22_10_tract-1lsr75',
                    'layout': {
                        'visibility': 'visible'
                    },
                    'paint': {
                        'fill-opacity': 0
                    }  
                });
                
                // Layer for 3D buildings
                map.addLayer({
                    'id': 'extruded-buildings',
                    'type': 'fill-extrusion',
                    'source': 'building',
                    'source-layer': 'building',
                    'layout': {
                        'visibility': 'visible'
                    },
                    'paint': {
                        'fill-extrusion-height': [
                            "interpolate",
                            ["linear"],
                            ["get", "height"],
                            0,
                            0,
                            500,
                            [
                                "case",
                                [
                                "==",
                                ["get", "height"],
                                0
                                ],
                                500,
                                500
                            ]
                        ],
                        'fill-extrusion-color': [
                            "interpolate",
                            ["linear"],
                            ["get", "height"],
                            0,
                            "hsl(257, 88%, 40%)",
                            150,
                            "hsl(197, 85%, 60%)",
                            300,
                            "hsl(163, 83%, 58%)"
                        ], //f7b6a6
                        'fill-extrusion-opacity': 0.6
                    }
                });

                // Layer for pseudo-heatmap glow, base
                map.addLayer({
                    'id': 'heat-glow-base',
                    'type': 'circle',
                    'source': 'dots',
                    'source-layer': 'alldata_geolocated-4rfe3o',
                    'filter': [
                        "all",
                        [
                            "match",
                            [
                            "get",
                            "OrganizationName"
                            ],
                            ["NA"],
                            false,
                            true
                        ]
                    ],
                    'layout': {
                        'visibility': 'visible'
                    },
                    'paint': {
                        'circle-color': [
                            "case",
                            [
                                "match",
                                ["get", "AcademicEducational"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.AcademicEducational,
                            [
                                "match",
                                ["get", "EarlyChildhood"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.EarlyChildhood,
                            [
                                "match",
                                ["get", "FoodNutrition"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.FoodNutrition,
                            [
                                "match",
                                ["get", "HealthHealthcare"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.HealthHealthcare,
                            [
                                "match",
                                ["get", "Housing"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Housing,
                            [
                                "match",
                                ["get", "MentalHealth"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.MentalHealth,
                            [
                                "match",
                                ["get", "Recreational"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Recreational,
                            [
                                "match",
                                ["get", "Transportation"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Transportation,
                            [
                                "match",
                                ["get", "Other"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Other,
                            CategoryColors.Other
                        ],
                        'circle-radius': [
                        "interpolate",
                        ["linear"],
                        ["zoom"],
                        0,
                        60,
                        15,
                        60,
                        17,
                        250,
                        20,
                        600
                        ],
                        'circle-blur': 3,
                        'circle-opacity': 0.4,
                        'circle-stroke-color': "#000000",
                        'circle-stroke-width': 0,
                        'circle-stroke-opacity': 1
                    }
                });

                // Layer for pseudo-heatmap glow, mid-range
                map.addLayer({
                    'id': 'heat-glow-mid',
                    'type': 'circle',
                    'source': 'dots',
                    'source-layer': 'alldata_geolocated-4rfe3o',
                    'filter': [
                        "all",
                        [
                            "match",
                            [
                            "get",
                            "OrganizationName"
                            ],
                            ["NA"],
                            false,
                            true
                        ]
                    ],
                    'layout': {
                        'visibility': 'visible'
                    },
                    'paint': {
                        'circle-color': [
                            "case",
                            [
                                "match",
                                ["get", "AcademicEducational"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.AcademicEducational,
                            [
                                "match",
                                ["get", "EarlyChildhood"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.EarlyChildhood,
                            [
                                "match",
                                ["get", "FoodNutrition"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.FoodNutrition,
                            [
                                "match",
                                ["get", "HealthHealthcare"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.HealthHealthcare,
                            [
                                "match",
                                ["get", "Housing"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Housing,
                            [
                                "match",
                                ["get", "MentalHealth"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.MentalHealth,
                            [
                                "match",
                                ["get", "Recreational"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Recreational,
                            [
                                "match",
                                ["get", "Transportation"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Transportation,
                            [
                                "match",
                                ["get", "Other"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Other,
                            CategoryColors.Other
                        ],
                        'circle-radius': [
                            "interpolate",
                            ["linear"],
                            ["zoom"],
                            0,
                            30,
                            15,
                            30,
                            17,
                            125,
                            20,
                            300
                        ],
                        'circle-blur': 1,
                        'circle-opacity': 0.4,
                        'circle-stroke-color': "#000000",
                        'circle-stroke-width': 0,
                        'circle-stroke-opacity': 1
                    }
                });

                // Layer for WEIC resources
                map.addLayer({
                    'id': 'weic-features', 
                    'type': 'circle',
                    'source': 'dots',
                    'source-layer': 'alldata_geolocated-4rfe3o',
                    'filter': [
                        "all",
                        [
                            "match",
                            [
                                "get",
                                "OrganizationName"
                            ],
                            ["NA"],
                            false,
                            true
                        ]
                    ],
                    'layout': {
                        'visibility': 'visible'
                    },
                    'paint': {
                        'circle-color': [
                            "case",
                            [
                                "match",
                                ["get", "AcademicEducational"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.AcademicEducational,
                            [
                                "match",
                                ["get", "EarlyChildhood"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.EarlyChildhood,
                            [
                                "match",
                                ["get", "FoodNutrition"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.FoodNutrition,
                            [
                                "match",
                                ["get", "HealthHealthcare"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.HealthHealthcare,
                            [
                                "match",
                                ["get", "Housing"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Housing,
                            [
                                "match",
                                ["get", "MentalHealth"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.MentalHealth,
                            [
                                "match",
                                ["get", "Recreational"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Recreational,
                            [
                                "match",
                                ["get", "Transportation"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Transportation,
                            [
                                "match",
                                ["get", "Other"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Other,
                            CategoryColors.Other
                        ],
                        'circle-radius': [
                            "interpolate",
                            ["linear"],
                            ["zoom"],
                            0,
                            6,
                            15,
                            6,
                            17,
                            25,
                            20,
                            60
                        ],
                        'circle-blur': 0,
                        'circle-opacity': [
                            "interpolate",
                            ["linear"],
                            ["zoom"],
                            9,
                            0,
                            15,
                            1
                        ],
                        'circle-stroke-color': "#000000",
                        'circle-stroke-width': 0,
                        'circle-stroke-opacity': 1
                    }
                });
            });

            // Collect all loaded resources into an object
            map.once('idle', () => {
                const AllDataFeatures = map.queryRenderedFeatures({layers: ['weic-features']}).map(
                    (features) => features.properties
                );
                categorizeDataFeatures(AllDataFeatures);
                console.log(Categories);

                setMyGeolocation();

                dotsdata = map.queryRenderedFeatures({layers: ['weic-features']});
                clearances = {
                    type: 'FeatureCollection',
                    features: dotsdata
                };
                resource = turf.buffer(clearances, 0.25, { units: 'kilometers' });
                console.log(clearances.features[0]._geometry);
                console.log(resource);
            });

            // Click functionality
            map.on('click', function(e) {
                //setting access for variables from data layers
                const CensusTract = map.queryRenderedFeatures(e.point, {
                    layers: ['census-tract-fills']
                }).map(
                    (feature) => feature.properties
                );
                const DataFeature = map.queryRenderedFeatures(e.point, {
                    layers: ['weic-features']
                }).map(
                    (feature) => feature.properties
                );

                console.log("DataFeature.length = " + DataFeature.length);
                console.log("CensusTract.length = " + CensusTract.length);
                //outputting resource data in a popup
                if (DataFeature.length > 0 && CensusTract.length > 0) {
                    console.log("entered first");
                    const clickcoordinates = [ DataFeature[0].Longitude, DataFeature[0].Latitude ];
                    while (Math.abs(e.lngLat.lng - clickcoordinates[0]) > 180) {
                        clickcoordinates[0] += e.lngLat.lng > clickcoordinates[0] ? 360 : -360;
                    }
                    new mapboxgl.Popup()
                    .setLngLat(clickcoordinates)
                    .setHTML(
                        `<b>Resource for Families/Children:</b><br>` + DataFeature[0].OrganizationName + `<br><br>` +
                        `<b>Resource Location:</b><br>` + DataFeature[0].Addresses + `<br><br>` +
                        `<b>Census Tract: ` + CensusTract[0].NAME + `</b><br>` +
                        `<br>` +
                        `<b>` + printCategories(DataFeature[0]) + `</b><br>` +
                        DataFeature[0].Description + `<br>`
                    )
                    .addTo(map);
                }
                else if (CensusTract.length > 0) {
                    console.log("entered second");
                    new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(
                        `<b>Census Tract: ` + CensusTract[0].NAME + `</b><br>`
                    )
                    .addTo(map);
                }
                
                //routes
                const coords = Object.keys(e.lngLat).map((key) => e.lngLat[key]);
                const end = {
                    type: 'FeatureCollection',
                    features: [
                        {
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'Point',
                                coordinates: coords
                            }
                        }
                    ]
                };
            });

            function categorizeDataFeatures(all) {
                console.log(all);
                //
                for (var i = 0; i < all.length; i++) {
                    if (all[i].FoodNutrition == "X") { Categories.FoodNutrition.push(all[i]); };
                    if (all[i].HealthHealthcare == "X") { Categories.HealthHealthcare.push(all[i]); };
                    if (all[i].AcademicEducational == "X") { Categories.AcademicEducational.push(all[i]); };
                    if (all[i].EarlyChildhood == "X") { Categories.EarlyChildhood.push(all[i]); };
                    if (all[i].Recreational == "X") { Categories.Recreational.push(all[i]); };
                    if (all[i].Housing == "X") { Categories.Housing.push(all[i]); };
                    if (all[i].MentalHealth == "X") { Categories.MentalHealth.push(all[i]); };
                    if (all[i].Transportation == "X") { Categories.Transportation.push(all[i]); };
                    if (all[i].Other == "X") { Categories.Other.push(all[i]); };
                }
            }
            function printCategories(df) {
                console.log(df);
                //
                var output = "";
                if (df.FoodNutrition == "X") { output += "Food & Nutrition<br/>" };
                if (df.HealthHealthcare == "X") { output += "Health & Healthcare<br/>" };
                if (df.AcademicEducational == "X") { output += "Academic & Educational<br/>" };
                if (df.EarlyChildhood == "X") { output += "Early Childhood<br/>" };
                if (df.Recreational == "X") { output += "Recreational<br/>" };
                if (df.Housing == "X") { output += "Housing<br/>" };
                if (df.MentalHealth == "X") { output += "Mental Health<br/>" };
                if (df.Transportation == "X") { output += "Transportation<br/>" };
                if (df.Other == "X") { output += "Other<br>" };
                return output;
            }

            // (De)select all resources
            function selectAllCatsUpdate(e) {
                var defaultarray = [
                                        'all',
                                        ['!=', 'OrganizationName', 'NA']
                                    ]
                                ;
                var allarray = [
                                    'all',
                                    ['!=','OrganizationName','NA'],
                                    ['!=','AcademicEducational','X'],
                                    ['!=','EarlyChildhood','X'],
                                    ['!=','FoodNutrition','X'],
                                    ['!=','HealthHealthcare','X'],
                                    ['!=','Housing','X'],
                                    ['!=','MentalHealth','X'],
                                    ['!=','Recreational','X'],
                                    ['!=','Transportation','X'],
                                    ['!=','Other','X']
                                ]
                            ;
                //
                if (!e.target.checked) { 
                    console.log(`Now it is Unchecked`); 
                    map.setFilter('weic-features', allarray);
                    map.setFilter('heat-glow-base', allarray);
                    map.setFilter('heat-glow-mid', allarray);
                }
                else if (e.target.checked) { 
                    console.log(`Now it is Checked`); 
                    map.setFilter('weic-features', defaultarray);
                    map.setFilter('heat-glow-base', defaultarray);
                    map.setFilter('heat-glow-mid', defaultarray);
                }
            }

            // Filter resources by category
            function filterCatsUpdate(e) {
                console.log("filterCatsUpdate called");
                console.log(e);
                //
                var defaultarray = [
                                        "all",
                                        ["!=", "OrganizationName", "NA"]
                                    ]
                                ;
                console.log({defaultarray});
                var filterarray = defaultarray;

                var selectionmethod = document.querySelector('input[name=selectionmethodslider]');
                var excludes = document.querySelectorAll('input[name=filters]:not(:checked)');
                var includes = document.querySelectorAll('input[name=filters]:checked');
                for (var j = 0; j < excludes.length; j++ ){
                    filterarray.push(["!=", excludes[j].value, "X"]);
                    /*
                    console.log(selectionmethod.value);
                    if (selectionmethod.value == "HardSelect") {
                        // For 'hard-selecting' -- points with multiple categories are hidden
                        // as long as even one of its categories is deselected
                        filterarray.push(["!=", excludes[j].value, "X"]);   
                    }
                    else if (selectionmethod.value == "SoftSelect") {
                        // For 'soft-selecting' -- points with multiple categories are retained,
                        // even if one of those categories are deselected
                        // as long as at least one of the point's other categories is selected
                        var bools = [ "any" ];
                        for (var i = 0; i < includes.length; i++) {
                            bools.push(["==", includes[i].value, 'X']);
                        }
                        filterarray.push(
                            [
                                "all",
                                bools
                            ]
                        );
                    }
                    */
                }
                console.log({filterarray});
                console.log(JSON.stringify(filterarray));

                if (!e.target.checked) { 
                    console.log("Now it is Unchecked"); 
                    map.setFilter('weic-features', filterarray);
                    map.setFilter('heat-glow-base', filterarray);
                    map.setFilter('heat-glow-mid', filterarray);
                }
                else if (e.target.checked) { 
                    console.log("Now it is Checked"); 
                    map.setFilter('weic-features', defaultarray);
                    map.setFilter('heat-glow-base', defaultarray);
                    map.setFilter('heat-glow-mid', defaultarray);
                } 
            }


            // Add functionality for routing
            let counter = 0;
            const maxAttempts = 50;
            let emoji = '';
            let collision = '';
            let detail = '';
            const reports = document.getElementById('reports');
            let clearances = {
                type: 'FeatureCollection',
                features: dotsdata
            };
            
            let resource = turf.buffer(clearances, 0.25, { units: 'kilometers' });
            let bbox = [0, 0, 0, 0];
            let polygon = turf.bboxPolygon(bbox);

            function addCard(id, element, clear, detail) {
                const card = document.createElement('div');
                card.className = 'card';
                // Add the response to the individual report created above
                const heading = document.createElement('div');
                // Set the class type based on clear value
                heading.className =
                    clear === true ? 'card-header route-found' : 'card-header resource-found';
                heading.innerHTML =
                    id === 0
                    ? `${emoji} The route ${collision}`
                    : `${emoji} Route ${id} ${collision}`;

                const details = document.createElement('div');
                details.className = 'card-details';
                details.innerHTML = `This ${detail} resources.`;

                card.appendChild(heading);
                card.appendChild(details);
                element.insertBefore(card, element.firstChild);
            }
            function noRoutes(element) {
                const card = document.createElement('div');
                card.className = 'card';
                // Add the response to the individual report created above
                const heading = document.createElement('div');
                heading.className = 'card-header no-route';
                emoji = '';
                heading.innerHTML = `${emoji} Ending search.`;

                // Add details to the individual report
                const details = document.createElement('div');
                details.className = 'card-details';
                details.innerHTML = `Resources found in all routes, in ${counter} tries.`;

                card.appendChild(heading);
                card.appendChild(details);
                element.insertBefore(card, element.firstChild);
            }
            directions.on('clear', () => {
                map.setLayoutProperty('theRoute', 'visibility', 'none');
                map.setLayoutProperty('theBox', 'visibility', 'none');
                
                counter = 0;
                reports.innerHTML = '';
            });
            directions.on('route', (event) => {
                // Hide the route and box by setting the opacity to zero
                map.setLayoutProperty('theRoute', 'visibility', 'none');
                map.setLayoutProperty('theBox', 'visibility', 'none');
                
                if (counter >= maxAttempts) {
                    noRoutes(reports);
                } else {
                    // Make each route visible
                    for (const route of event.route) {
                        // Make each route visible
                        map.setLayoutProperty('theRoute', 'visibility', 'visible');
                        map.setLayoutProperty('theBox', 'visibility', 'visible');
                    
                        // Get GeoJSON LineString feature of route
                        const routeLine = polyline.toGeoJSON(route.geometry);
                    
                        // Create a bounding box around this route
                        // The app will find a random point in the new bbox
                        bbox = turf.bbox(routeLine);
                        polygon = turf.bboxPolygon(bbox);
                    
                        // Update the data for the route
                        // This will update the route line on the map
                        map.getSource('theRoute').setData(routeLine);
                        
                        // Update the box
                        map.getSource('theBox').setData(polygon);
                        
                        const clear = turf.booleanDisjoint(resource, routeLine);
                        
                        if (clear === true) {
                            // Collision did not occur
                            collision = 'does not intersect any resources!';
                            detail = `takes ${(route.duration / 60).toFixed(0)} minutes and finds NO`;
                            emoji = '';
                            map.setPaintProperty('theRoute', 'line-color', '#74c476');
                            // Hide the box
                            map.setLayoutProperty('theBox', 'visibility', 'none');
                            // Reset the counter
                            counter = 0;
                        } else {
                            // Collision occurred, so increment the counter
                            counter = counter + 1;
                            // As the attempts increase, expand the search area
                            // by a factor of the attempt count
                            polygon = turf.transformScale(polygon, counter * 0.01);
                            bbox = turf.bbox(polygon);
                            collision = 'intersects resources!';
                            detail = `takes ${(route.duration / 60).toFixed(0)} minutes and finds`;
                            emoji = '';
                            map.setPaintProperty('theRoute', 'line-color', '#de2d26');
                        
                            // Add a randomly selected waypoint to get a new route from the Directions API
                            const randomWaypoint = turf.randomPoint(1, { bbox: bbox });
                            directions.setWaypoint(
                                0,
                                randomWaypoint['features'][0].geometry.coordinates
                            );
                        }
                        // Add a new report section to the sidebar
                        addCard(counter, reports, clear, detail);
                    }
                }
            });




            // 3D Content
            // Add 3D logic to integrate Three.js with Mapbox GL JS
            //
            // parameters to ensure the model is georeferenced correctly on the map
            var modelOrigins = [];
            for(var i = 0; i < TechImpactLocations.features.length; i++){
                modelOrigins.push(TechImpactLocations.features[i].geometry.coordinates);
            }

            var modelAltitude = 1;
            var modelRotate = [Math.PI / 2, 0, 0];

            var modelAsMercatorCoordinates = [];
            for(var i = 0; i < modelOrigins.length; i++){
                modelAsMercatorCoordinates.push(
                    mapboxgl.MercatorCoordinate.fromLngLat(
                        modelOrigins[i],
                        modelAltitude
                    )
                );
            }
            console.log(modelAsMercatorCoordinates);

            // transformation parameters to position, rotate and scale the 3D model onto the map
            var modelTransforms = [];
            for(var i = 0; i < modelAsMercatorCoordinates.length; i++){
                modelTransforms.push(
                    {
                        translateX: modelAsMercatorCoordinates[i].x,
                        translateY: modelAsMercatorCoordinates[i].y,
                        translateZ: modelAsMercatorCoordinates[i].z,
                        rotateX: modelRotate[0],
                        rotateY: modelRotate[1],
                        rotateZ: modelRotate[2], 
                        scale: modelAsMercatorCoordinates[i].meterInMercatorCoordinateUnits()
                    }
                )
            }
            console.log(modelTransforms);

            var customLayer = {
                id: '3d-model',
                type: 'custom',
                renderingMode: '3d',
                onAdd: function (map, gl) {
                    this.camera = new THREE.Camera();
                    this.scene = new THREE.Scene();

                    // create two three.js lights to illuminate the model
                    var directionalLight = new THREE.DirectionalLight(0xffffff);
                    directionalLight.position.set(0, -70, 100).normalize();
                    this.scene.add(directionalLight);

                    var directionalLight2 = new THREE.DirectionalLight(0xffffff);
                    directionalLight2.position.set(0, 70, 100).normalize();
                    this.scene.add(directionalLight2);

                    // use the three.js GLTF loader to add the 3D model to the three.js scene
                    var loader = new THREE.GLTFLoader();
                    loader.load(
                        'https://docs.mapbox.com/mapbox-gl-js/assets/34M_17/34M_17.gltf',
                        function (gltf) {
                                gltf.name = "PowerTower";
                                console.log(gltf);
                                this.scene.add(gltf.scene);
                            }.bind(this)
                    );
                    this.map = map;

                    // use the Mapbox GL JS map canvas for three.js
                    this.renderer = new THREE.WebGLRenderer({
                        canvas: map.getCanvas(),
                        context: gl,
                        antialias: true
                    });

                    this.renderer.autoClear = false;
                },
                render: function (gl, matrix) {
                    //one for each TechImpactLocation.feature
                    //
                    for(var i = 0; i < modelTransforms.length; i++) {
                        //
                        var rotationX = new THREE.Matrix4().makeRotationAxis(
                            new THREE.Vector3(1, 0, 0),
                            modelTransforms[i].rotateX
                        );
                        var rotationY = new THREE.Matrix4().makeRotationAxis(
                            new THREE.Vector3(0, 1, 0),
                            modelTransforms[i].rotateY
                        );
                        var rotationZ = new THREE.Matrix4().makeRotationAxis(
                            new THREE.Vector3(0, 0, 1),
                            modelTransforms[i].rotateZ
                        );

                        var m = new THREE.Matrix4().fromArray(matrix);
                        var l = new THREE.Matrix4()
                            .makeTranslation(
                                modelTransforms[i].translateX,
                                modelTransforms[i].translateY,
                                modelTransforms[i].translateZ
                            )
                            .scale(
                                new THREE.Vector3(
                                    modelTransforms[i].scale,
                                    -modelTransforms[i].scale,
                                    modelTransforms[i].scale
                                )
                            )
                            .multiply(rotationX)
                            .multiply(rotationY)
                            .multiply(rotationZ);

                        this.camera.projectionMatrix = m.multiply(l);
                        this.renderer.state.reset();
                        this.renderer.render(this.scene, this.camera);
                        this.map.triggerRepaint();
                    }
                }
            };
            // Add 3D layer
            map.on('style.load', function () {
                map.addLayer(customLayer, 'waterway-label');
            });


            //3d graphs - topology
            //
            var topologyOrigin = params.center;
            var topologyAltitude = 1;
            var topologyRotate = [Math.PI / 2, 0, 0];

            var topologyAsMercatorCoordinates = 
                mapboxgl.MercatorCoordinate.fromLngLat(
                    topologyOrigin,
                    topologyAltitude
                );
            
            var topologyTransform = {
                translateX: topologyAsMercatorCoordinates.x,
                translateY: topologyAsMercatorCoordinates.y,
                translateZ: topologyAsMercatorCoordinates.z,
                rotateX: topologyRotate[0],
                rotateY: topologyRotate[1],
                rotateZ: topologyRotate[2], 
                scale: topologyAsMercatorCoordinates.meterInMercatorCoordinateUnits()
            };
            //

            var zFuncText = "x^2 - y^2";
            var zFunc = Parser.parse(zFuncText).toJSFunction( ['x','y']);

            var a = 0.01, b = 0.01, c = 0.01, d = 0.01;
            var segments = 20,
                xMin = -10, xMax = 10, xRange = xMax - xMin,
                yMin = -10, yMax = 10, yRange = yMax - yMin,
                zMin = -10, zMax = 10, zRange = zMax - zMin;
            var topologyGeometry;
            var topologyMesh;

            var topologyLayer = {
                id: 'topology',
                type: 'custom',
                renderingMode: '3d',
                onAdd: function (map, gl) {
                    this.camera = new THREE.Camera();
                    this.scene = new THREE.Scene();

                    // create two three.js lights to illuminate the topology
                    var directionalLight = new THREE.DirectionalLight(0xffffff);
                    directionalLight.position.set(0, -70, 100).normalize();
                    this.scene.add(directionalLight);

                    var directionalLight2 = new THREE.DirectionalLight(0xffffff);
                    directionalLight2.position.set(0, 70, 100).normalize();
                    this.scene.add(directionalLight2);

                    // create the geometry here
                    xRange = xMax - xMin;
                    yRange = yMax - yMin;
                    zFunc = Parser.parse(zFuncText).toJSFunction( ['x','y']);
                    
                    meshFunction = function(x, y) 
                    {
                        x = xRange * x + xMin;
                        y = yRange * y + yMin;
                        var z = zFunc(x,y);
                        if (isNaN(z) ) { 
                            return new THREE.Vector3(0,0,0); 
                        }
                        else { 
                            return new THREE.Vector3(x, y, z); 
                        }
                    };
                    topologyGeometry = new THREE.ParametricGeometry( meshFunction(segments, segments));

                    //
                    // create the material here
                    var standardTopologyMaterial = new THREE.MeshStandardMaterial({
                        color: 'lightblue', 
                        roughness: .5,
                        metalness:.02, 
                        side: THREE.DoubleSide,
                        wireframe: false
                    });
                    //
                    
                    // create the mesh here from the geometry and the material
                    if (topologyMesh) { 
                        this.scene.remove( topologyMesh ); 
                    }
                    topologyMesh = new THREE.Mesh( topologyGeometry, standardTopologyMaterial );
                    topologyMesh.doubleSided = true;
                    topologyMesh.name = "topologyMesh";
                    console.log(topologyMesh);
                    this.scene.add(topologyMesh);
                    //
                    // end of creating the topology

                    this.map = map;

                    // use the Mapbox GL JS map canvas for three.js
                    this.renderer = new THREE.WebGLRenderer({
                        alpha: true,
                        canvas: map.getCanvas(),
                        context: gl,
                        antialias: true
                    });
                    this.renderer.shadowMap.enabled = true;
                    this.renderer.autoClear = false;
                },
                render: function (gl, matrix) {
                    var rotationX = new THREE.Matrix4().makeRotationAxis(
                        new THREE.Vector3(1, 0, 0),
                        topologyTransform.rotateX
                    );
                    var rotationY = new THREE.Matrix4().makeRotationAxis(
                        new THREE.Vector3(0, 1, 0),
                        topologyTransform.rotateY
                    );
                    var rotationZ = new THREE.Matrix4().makeRotationAxis(
                        new THREE.Vector3(0, 0, 1),
                        topologyTransform.rotateZ
                    );
                    var m = new THREE.Matrix4().fromArray(matrix);
                    var l = new THREE.Matrix4()
                        .makeTranslation(
                            topologyTransform.translateX,
                            topologyTransform.translateY,
                            topologyTransform.translateZ
                        )
                        .scale(
                            new THREE.Vector3(
                                topologyTransform.scale,
                                -topologyTransform.scale,
                                topologyTransform.scale
                            )
                        )
                        .multiply(rotationX)
                        .multiply(rotationY)
                        .multiply(rotationZ);

                    this.camera.projectionMatrix = m.multiply(l);
                    this.renderer.state.reset();
                    this.renderer.render(this.scene, this.camera);
                    this.map.triggerRepaint();
                }
            };

            // Add 3D layer
            map.on('style.load', function () {
                map.addLayer(topologyLayer, 'waterway-label');
            });
        </script>
    </body>
</html>