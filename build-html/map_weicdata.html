<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Map Visualization of DE Open Data (DTI)</title>
        <meta name="description" content="You are here, in a 3D map of DE Open Data">
        <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
        <meta http-equiv="cache-control" content="no-cache">
        <meta http-equiv="expires" content="0">
        <meta http-equiv="pragma" content="no-cache">

        <!-- Mapbox -->
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
        <!--
        Mapbox Geocoder
        -->
        <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js'></script>
        <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css' type='text/css' />
        

        <!-- Three.js -->
        <script src="https://unpkg.com/three@0.148.0/build/three.min.js"></script>

        <!-- D3.js  -->
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="https://d3js.org/d3-collection.v1.min.js"></script>
        <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
        <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
        <script src="https://d3js.org/d3-request.v1.min.js"></script>

        <style type="text/css">
            body {
                margin: 0;
                padding: 0;
            }
            #map {
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            .menubar {
                background: #fff;
                position: relative;
                left: 0.7rem;
                top: 0.7rem;
                padding: 1rem;
                margin: 0.5rem;
                width: 22.5rem;
                border: none;
                border-radius: 0.5rem;
                box-shadow: 0 -3em 3em rgba(0, 0, 0, 0.1), 0 0 0 2px rgb(255, 255, 255),
                            0.3em 0.3em 1em rgba(0, 0, 0, 0.3);
                background-color: #fff;
                font-family: 'Open Sans', sans-serif;
            }
            .listbar {
                background: #fff;
                position: absolute;
                right: 0.7rem;
                top: 6.8rem;
                padding: 1rem;
                margin: 0.5rem;
                width: 22.5rem;
                border: none;
                border-radius: 0.5rem;
                box-shadow: 0 -3em 3em rgba(0, 0, 0, 0.1), 0 0 0 2px rgb(255, 255, 255),
                            0.3em 0.3em 1em rgba(0, 0, 0, 0.3);
                background-color: #fff;
                font-family: 'Open Sans', sans-serif;
            }
            #satellite {
                margin: 0 auto;
                background-color: rgb(0, 176, 225);
                color: #fff;
                font-weight: bold;
                padding: 0.5em;
                border: 2px solid #fff;
                border-radius: 0.5em;
                box-shadow: 0px 0px 5px rgba(0,0,0,0.2);
                cursor: pointer;
                position: absolute;
                left: 27em;
                top: 1.2em;
                font-family: 'Open Sans', sans-serif;
            }
            #satellite:hover {
                background-color: rgb(1, 153, 195);
            }
        </style>
    </head>
    <body>
        <!-- HTML :: Mapbox -->
        <div id="map"></div>
        <div id="menu" class="menubar">
            <input id="extruded-buildings" type="checkbox" name="toggle" value="extruded-buildings" checked="checked">
            <label for="extruded-buildings">Buildings</label>
            <br>
            <input id="weic-features" type="checkbox" name="toggle" value="weic-features" checked="checked">
            <label for="weic-features">Resources ~ Wilmington Education Improvement Commission</label>
        </div>
        <div id="readout" class="menubar"></div>
        <div id="catlist" class="listbar">
            <input class="filter_FoodNutrition" id="FoodNutrition" name="filters" value="FoodNutrition" type="checkbox"
                onchange="filterCatsUpdate.call(this, event)"
                checked="checked">Food & Nutrition</input>
            <br>
            <input class="filter_HealthHealthcare" id="HealthHealthcare" name="filters" value="HealthHealthcare" type="checkbox"
                onchange="filterCatsUpdate.call(this, event)"
                checked="checked">Health & Healthcare</input>
            <br>
            <input class="filter_AcademicEducational" id="AcademicEducational" name="filters" value="AcademicEducational" type="checkbox"
                onchange="filterCatsUpdate.call(this, event)"
                checked="checked">Academic & Educational</input>
            <br>
            <input class="filter_EarlyChildhood" id="EarlyChildhood" name="filters" value="EarlyChildhood" type="checkbox"
                onchange="filterCatsUpdate.call(this, event)"
                checked="checked">Early Childhood</input>
            <br>
            <input class="filter_Recreational" id="Recreational" name="filters" value="Recreational" type="checkbox"
                onchange="filterCatsUpdate.call(this, event)"
                checked="checked">Recreational</input>
            <br>
            <input class="filter_Housing" id="Housing" name="filters" value="Housing" type="checkbox"
                onchange="filterCatsUpdate.call(this, event)"
                checked="checked">Housing</input>
            <br>
            <input class="filter_MentalHealth" id="MentalHealth" name="filters" value="MentalHealth" type="checkbox"
                onchange="filterCatsUpdate.call(this, event)"
                checked="checked">Mental Health</input>
            <br>
            <input class="filter_Transportation" id="Transportation" name="filters" value="Transportation" type="checkbox"
                onchange="filterCatsUpdate.call(this, event)"
                checked="checked">Transportation</input>
            <br>
            <input class="filter_Other" id="Other" name="filters" value="Other" type="checkbox"
                onchange="filterCatsUpdate.call(this, event)"
                checked="checked">Other</input>
        </div>
        <div id='satellite'>Add satellite</div>

        <!-- JS :: Mapbox -->
        <script>
            const params = {
                accessToken: 'pk.eyJ1IjoibGlsbXJob3VzZSIsImEiOiJja3d1cm5nOHQxdDlrMnZueWY4dzlrbHY2In0.g14m2o2rHvNYYdDSsjwmqQ',
                styles: {
                    warmfuzzy: 'mapbox://styles/lilmrhouse/clckubrie00dw14qtav0gsq4u'
                },
                center: [
                    -75.551,
                    39.738
                ],
                projections: {
                    mercator: 'globe'
                },
                hash: false,
                pitch: 60,
                zoom: 16.09,
                minZoom: 0,
                maxZoom: 50,
                scrollZoom: true
            };
            var Categories = {
                FoodNutrition: [], 
                HealthHealthcare: [], 
                AcademicEducational: [], 
                EarlyChildhood: [], 
                Recreational: [], 
                Housing: [], 
                MentalHealth: [], 
                Transportation: [], 
                Other: []
            };
            var CategoryColors = {
                FoodNutrition: "#A8E10C",       //A8E10C - Kelly Green
                HealthHealthcare: "#FF5765",    //FF5765 - Coral
                AcademicEducational: "#01DEE6", //01DEE6 - Teal
                EarlyChildhood: "#FFDB15",      //FFDB15 - Yellow
                Recreational: "#FF66E9",        //FF66E9 - Hot Pink
                Housing: "#952B60",             //952B60 - Dark Pink
                MentalHealth: "#8A6FDF",        //8A6FDF - Violet
                Transportation: "#3D91E0",      //3D91E0 - Deep Blue 
                Other: "#FDA649"                //FDA649 - Beige Orange
            };
            mapboxgl.accessToken = params.accessToken;

            const menu = document.getElementById('menu');
            const inputs = menu.getElementsByTagName('input');
            const catlist = document.getElementById('catlist');
            const readout = document.getElementById('readout');
            const satelliteSwitch = document.getElementById('satellite');

            for (const input of inputs) {
                input.onclick = (style) => {
                    const propertySelected = style.target.value;
                    if (!input.checked) {
                        switch (propertySelected) {
                            case "extruded-buildings":
                                map.setLayoutProperty('extruded-buildings', 'visibility', 'none');
                                break;
                            case "weic-features":
                                map.setLayoutProperty('weic-features', 'visibility', 'none');
                                break;
                        }
                    }
                    else if (input.checked) {
                        switch (propertySelected) {
                            case "extruded-buildings":
                                map.setLayoutProperty('extruded-buildings', 'visibility', 'visible');
                                break;
                            case "weic-features":
                                map.setLayoutProperty('weic-features', 'visibility', 'visible');
                                break;
                        }
                    }
                    
                };
            }
            
            satelliteSwitch.onclick = () => {
                if (satelliteSwitch.classList.contains("on")) {
                    map.setLayoutProperty('satellite', 'visibility', 'none');
                    satelliteSwitch.classList.toggle('on');
                    satelliteSwitch.innerHTML = "Add satellite";
                }
                else {
                    map.setLayoutProperty('satellite', 'visibility', 'visible');
                    satelliteSwitch.classList.toggle('on');
                    satelliteSwitch.innerHTML = "Remove satellite";
                }
            }
            
            const map = new mapboxgl.Map({
                container: 'map',
                style: params.styles.warmfuzzy,
                projection: params.projections.mercator,
                center: params.center,
                hash: params.hash,
                pitch: params.pitch,
                zoom: params.zoom,
                minZoom: params.minZoom,
                maxZoom: params.maxZoom,
                scrollZoom: params.scrollZoom,
                attributionControl: {
                    position: 'bottom-left'
                }
            });
            const geocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl,
                marker: false,
                proximity: {
                    longitude: params.center[0],
                    latitude: params.center[1]
                }
            });
            map.addControl( geocoder );

            map.on('load', () => {
                map.addSource('building', {
                    type: 'vector',
                    url: 'mapbox://mapbox.mapbox-streets-v8'
                });
                map.addSource('census-tract-shapefile', {
                    type: 'vector',
                    url: 'mapbox://lilmrhouse.3gd9m3do'
                });
                map.addSource('dots', {
                    type: 'vector',
                    url: 'mapbox://lilmrhouse.5ldfh4fb'
                })

                map.addLayer({
                    'id': 'satellite',
                    'source': {
                        'type': 'raster',
                        'url': 'mapbox://mapbox.satellite',
                        'tileSize': 256
                    },
                    'type': 'raster',
                    'layout': {
                        'visibility': 'none'
                    }
                });
                map.addLayer({
                    'id': 'census-tract-fills',
                    'type': 'fill',
                    'source': 'census-tract-shapefile',
                    'source-layer': 'tl_2020_10_tract-9uewme',
                    'layout': {
                        'visibility': 'visible'
                    },
                    'paint': {
                        'fill-opacity': 0
                    }  
                });
                map.addLayer({
                    'id': 'extruded-buildings',
                    'type': 'fill-extrusion',
                    'source': 'building',
                    'source-layer': 'building',
                    'layout': {
                        'visibility': 'visible'
                    },
                    'paint': {
                        'fill-extrusion-height': 
                        [
                        "interpolate",
                        ["linear"],
                        ["get", "height"],
                        0,
                        0,
                        1500,
                        1500
                        ],
                        'fill-extrusion-color': "hsl(12, 83%, 81%)",
                        'fill-extrusion-opacity': 0.9
                    }
                });
                map.addLayer({
                    'id': 'weic-features', 
                    'type': 'circle',
                    'source': 'dots',
                    'source-layer': 'alldata_geolocated-981eop',
                    'filter': [
                        "all",
                        [
                            "match",
                            [
                            "get",
                            "OrganizationName"
                            ],
                            ["NA"],
                            false,
                            true
                        ]
                    ],
                    'layout': {
                        'visibility': 'visible'
                    },
                    'paint': {
                        'circle-color': [
                            "case",
                            [
                                "match",
                                ["get", "FoodNutrition"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.FoodNutrition,
                            [
                                "match",
                                ["get", "HealthHealthcare"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.HealthHealthcare,
                            [
                                "match",
                                ["get", "AcademicEducational"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.AcademicEducational,
                            [
                                "match",
                                ["get", "EarlyChildhood"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.EarlyChildhood,
                            [
                                "match",
                                ["get", "Recreational"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Recreational,
                            [
                                "match",
                                ["get", "Housing"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Housing,
                            [
                                "match",
                                ["get", "MentalHealth"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.MentalHealth,
                            [
                                "match",
                                ["get", "Transportation"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Transportation,
                            [
                                "match",
                                ["get", "Other"],
                                ["X"],
                                true,
                                false
                            ],
                            CategoryColors.Other,
                            "#000000"
                        ],
                        'circle-radius': 6,
                        'circle-opacity': 1,
                        'circle-stroke-color': "#000000",
                        'circle-stroke-width': 0,
                        'circle-stroke-opacity': 1
                    }
                });
            });


            map.once('idle', () => {
                const AllDataFeatures = map.queryRenderedFeatures({layers: ['weic-features']}).map(
                    (features) => features.properties
                );
                categorizeDataFeatures(AllDataFeatures);
                console.log(Categories);
            });


            map.on('click', function(e) {
                const CensusTract = map.queryRenderedFeatures(e.point, {
                    layers: ['census-tract-fills']
                }).map(
                    (feature) => feature.properties
                );
                const DataFeature = map.queryRenderedFeatures(e.point, {
                    layers: ['weic-features']
                }).map(
                    (feature) => feature.properties
                );

                switch(DataFeature.length) {
                    case 0:
                        readout.innerHTML = ``;
                        break;
                    default:
                        readout.innerHTML = 
                            `<b>Name</b><br>` + DataFeature[0].OrganizationName + `<br><br>` +
                            `<b>Address</b><br>` + DataFeature[0].Addresses + `<br><br>` +
                            `<b>` + CensusTract[0].NAMELSAD + `</b><br>` +
                            `<b>` + "______________" + `</b><br><br>` +
                            `<b>` + printCategories(DataFeature[0]) + `</b><br>` +
                            DataFeature[0].Description + `<br>`
                        ;
                        break;
                }
            });

            function categorizeDataFeatures(all) {
                console.log(all);
                //
                for (var i = 0; i < all.length; i++){
                    if (all[i].FoodNutrition == "X") { Categories.FoodNutrition.push(all[i]); };
                    if (all[i].HealthHealthcare == "X") { Categories.HealthHealthcare.push(all[i]); };
                    if (all[i].AcademicEducational == "X") { Categories.AcademicEducational.push(all[i]); };
                    if (all[i].EarlyChildhood == "X") { Categories.EarlyChildhood.push(all[i]); };
                    if (all[i].Recreational == "X") { Categories.Recreational.push(all[i]); };
                    if (all[i].Housing == "X") { Categories.Housing.push(all[i]); };
                    if (all[i].MentalHealth == "X") { Categories.MentalHealth.push(all[i]); };
                    if (all[i].Transportation == "X") { Categories.Transportation.push(all[i]); };
                    if (all[i].Other == "X") { Categories.Other.push(all[i]); };
                }
            }
            function printCategories(df) {
                    console.log(df);
                    //
                    var output = "";
                    if (df.FoodNutrition == "X") { output += "Food & Nutrition<br/>" };
                    if (df.HealthHealthcare == "X") { output += "Health & Healthcare<br/>" };
                    if (df.AcademicEducational == "X") { output += "Academic & Educational<br/>" };
                    if (df.EarlyChildhood == "X") { output += "Early Childhood<br/>" };
                    if (df.Recreational == "X") { output += "Recreational<br/>" };
                    if (df.Housing == "X") { output += "Housing<br/>" };
                    if (df.MentalHealth == "X") { output += "Mental Health<br/>" };
                    if (df.Transportation == "X") { output += "Transportation<br/>" };
                    if (df.Other == "X") { output += "Other<br>" };
                    return output;
                }

            function filterCatsUpdate(e) {
                console.log("filterCatsUpdate called");
                console.log(e);
                //
                var defaultarray = [
                                    "all",
                                    [
                                        "match",
                                        [
                                        "get",
                                        "OrganizationName"
                                        ],
                                        ["NA"],
                                        false,
                                        true
                                    ]
                                    ]
                                ;
                console.log({defaultarray});
                var filterarray = defaultarray;

                var excludes = document.querySelectorAll('input[name=filters]:not(:checked)');
                for (var i = 0; i < excludes.length; i++ ){
                    console.log(excludes[i].value);
                    filterarray.push(
                        [
                            "match",
                            [
                            "get",
                            excludes[i].value
                            ],
                            ["X"],
                            false,
                            true
                        ]
                    );
                }
                console.log({filterarray});

                if (!e.target.checked) { 
                    console.log("Now it is Unchecked"); 
                    map.setFilter('weic-features', filterarray);
                }
                else if (e.target.checked) { 
                    console.log("Now it is Checked"); 
                    map.setFilter('weic-features', defaultarray);
                } 
            }


            const THREE = window.THREE;
            
        </script>
    </body>
</html>